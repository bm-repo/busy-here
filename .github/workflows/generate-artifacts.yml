on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  bundle_artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Generating tests
        uses: actions/checkout@v3
      - run: mkdir -p path/to/artifact
      - run: echo hello1 > path/to/artifact/test_file1.txt
      - run: echo hello2 > path/to/artifact/test_file2.txt
      
      - name: Tar test files
        run: tar -cvf ${{github.event.number}}_tests.tar path/to/artifact

      - name: Upload test files as artifact
        uses: actions/upload-artifact@v3
        with:
          name: testcases-artifact-${{github.event.number}}
          path: ${{github.event.number}}_tests.tar
  notify:
      runs-on: ubuntu-latest
      needs: bundle_artifacts
      steps:
        - name: Notify the PR owner
          uses: actions/github-script@v5
          with:
            github-token: ${{secrets.GITHUB_TOKEN}}
            script: |
              setTimeout(async () => {
                console.log(`${context.run_id} Run ID`);
                var artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                   owner: context.repo.owner,
                   repo: context.repo.repo,
                   run_id: context.run_id
                });
                var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
                  return artifact.name === `testcases-artifact-${context.issue.number}`
                })[0];
                var downloadResponse = await github.rest.actions.downloadArtifact({
                   owner: context.repo.owner,
                   repo: context.repo.repo,
                   artifact_id: matchArtifact.id,
                   archive_format: 'zip'
                });
                console.log(JSON.stringify(downloadResponse));
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `Unit Test cases for this PR are generated. Click [here](${downloadResponse.url}) to download the testcases.`
                });
              }, 3000);
