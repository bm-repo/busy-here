on:
  workflow_run: 
    workflows: ["build_artifacts"]
  # Trigger the workflow on push or pull request
  pull_request:
    branches:
      - main
      - develop

jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v5
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            console.log(process.env.artifacts_run_id);
            const id = setInterval(async () => {
                var artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                   owner: context.repo.owner,
                   repo: context.repo.repo,
                   run_id: context.runId
                });
                var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
                  return artifact.name === `testcases-artifact-${context.issue.number}`
                })[0];
                if (matchArtifact) {
                  var downloadResponse = await github.rest.actions.downloadArtifact({
                     owner: context.repo.owner,
                     repo: context.repo.repo,
                     artifact_id: matchArtifact.id,
                     archive_format: 'zip'
                  });
                  console.log(JSON.stringify(downloadResponse));
                  await github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: `Unit Test cases for this PR are generated. Click [here](${downloadResponse.url}) to download the testcases.`
                  });
                  clearInterval(id);
                } else {
                  console.log(`Sleeping for 2 seconds, will retry after 2 seconds`);
                }
              }, 2000);
